# syno
synology config and scripts

## Certificate renewal

Synology NAS has Let's Encrypt Certificate retrieval built-in. However, automated renewal through Synology's certificate manager only works if the NAS is exposed to the Internet. In case, it is not, you need a workaround like these scripts and a DNS server that allows connections from Let's Encrypt or some kind of DNS API (OVH and other mature registrars offer that). These scripts are written for tinydns DNS server.

### refresh-cert.sh

* Execution host: NAS devices
* Executed by: Task Scheduler (Synology NAS -> Control Panel -> System)
* Purpose: Obtains the latest certificates from public server

### cronjob.sh

* Execution host: Public server
* Executed by: cron daemon
* Purpose: Check certificate validity including chain and decide if a new certificate should be requested from Let's Encrypt

### gen-key-and-csr.sh

* Execution host: Public server
* Executed by: - (manual execution)
* Purpose: Create new keys or CSRs

### manual-auth-hook.pl

* Execution host: Public server
* Executed by: certbot
* Purpose: Set up the Let's Encrypt DNS challenges for tinydns/djbdns

### obtain.sh

* Execution host: Public server
* Executed by: cronjob.sh
* Purpose: Obtain new certificate (including chain) from Let's Encrypt

## MediaWiki configuration

Synology has a built-in package for MediaWiki but that uses an outdated PHP version and Apache, both of them aren't installed by default. Why not use PHP-FPM and nginx, both running on the machine?

### wiki.conf

1. Install Web Station
2. Install PHP-FPM (newest version)
3. Create a vhost using nginx+PHP-FPM
4. Integrate `wiki.conf` into the nginx config: `cp wiki.conf /etc/nginx/sites-enabled` but make sure the PHP-FPM socket is the correct one (look into the config generated by the Synology GUI)
5. Test the configuration `nginx -t`
6. Reload the web station `synoservicectl --reload pkgctl-WebStation ; synoservicectl --reload nginx`
7. Ensure the web station is not in secure/safe/panic or whatever mode, in which case it ignores `/etc/nginx/sites-enabled`
